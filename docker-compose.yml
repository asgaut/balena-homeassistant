version: "2.1"
volumes:
    hass-config:
    mosquitto:
    zigbee2mqtt-data:
    tailscale-state: {}
services:
  homeassistant:
    build: homeassistant
    ports:
      - 80:8123
    privileged: true
    volumes:
      - 'hass-config:/config'
    restart: always
  mqtt:
    build: mqtt
    ports:
      - "1883:1883"
    restart: always
    volumes:
      - mosquitto:/mosquitto/data
  hass-configurator:
    image: "causticlab/hass-configurator-docker:latest"
    restart: always
    ports:
      - "3218:3218"
    volumes:
      - 'hass-config:/hass-config'
    environment:
      - HC_BASEPATH=/hass-config
  zigbee2mqtt:
    container_name: zigbee2mqtt
    image: koenkk/zigbee2mqtt
    restart: unless-stopped
    privileged: true
    volumes:
      - "zigbee2mqtt-data:/app/data"
    ports:
      # Frontend port
      - 8080:8080
    environment:
      - TZ=Europe/Berlin
      - ZIGBEE2MQTT_CONFIG_SERIAL_PORT=/dev/ttyACM0
      - ZIGBEE2MQTT_CONFIG_SERIAL_ADAPTER=deconz
      - ZIGBEE2MQTT_CONFIG_MQTT_SERVER=mqtt://mqtt
      - ZIGBEE2MQTT_CONFIG_HOMEASSISTANT=true
      - ZIGBEE2MQTT_CONFIG_FRONTEND=true
      - ZIGBEE2MQTT_CONFIG_PERMIT_JOIN=false
      - ZIGBEE2MQTT_CONFIG_ADVANCED_LOG_LEVEL=warn
    devices:
      # Make sure this matches your adapter location
      - "/dev/ttyACM0:/dev/ttyACM0"
  price-control:
    container_name: price-control
    build: price-control
    restart: unless-stopped
    environment:
      - TZ=Europe/Berlin
      - MQTT_SERVER=mqtt
  tailscale:
    # Based on https://github.com/hslatman/tailscale-balena-block
    build:
      context: tailscale
      dockerfile: Dockerfile.template
    restart: unless-stopped
    network_mode: host
    privileged: true
    environment:
      # Set via Balena device variable instead
      # - TAILSCALE_KEY: <YOUR_TAILSCALE_KEY>
      - TAILSCALE_IP=true
      #- TAILSCALE_TAGS=tag:homeassistant
    volumes:
      - tailscale-state:/tailscale
    labels:
      # Required to get BALENA_API_KEY set inside container
      io.balena.features.balena-api: '1'
